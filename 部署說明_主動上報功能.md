# MT5 Monitor - 主動上報功能部署說明

## 功能概述

### 新增功能
1. **MT5 主動上報模式**
   - 模式 A（輪詢模式）：MT5 每 10 秒檢查是否有上報請求
   - 模式 B（定時模式）：按設定時間自動上報（原有功能）
   
2. **Web 要求上報按鈕**
   - 點擊後發送上報請求給所有 MT5
   - MT5 收到請求後立即上報數據並更新快照
   
3. **定時自動上報**
   - 倫敦時間 23:45 自動要求上報
   - 倫敦時間 10:00 自動要求上報
   
4. **場上手數顯示**
   - MT5 發送當前未平倉的總手數
   - Web 顯示橙色數值
   
5. **顏色調整**
   - 總回佣改為淺藍色（cyan-400），與 A手數總數一致

---

## 部署步驟

### 1. 後端部署

#### 1.1 複製文件到 VPS

```
本地 → VPS

# 後端文件
D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\src\app.js
→ C:\MT5_Monitor\mt5-monitor\backend\src\app.js

D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\src\database\db.js
→ C:\MT5_Monitor\mt5-monitor\backend\src\database\db.js

D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\src\database\schema.sql
→ C:\MT5_Monitor\mt5-monitor\backend\src\database\schema.sql

D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\src\routes\api.js
→ C:\MT5_Monitor\mt5-monitor\backend\src\routes\api.js

D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\src\services\scheduler.js
→ C:\MT5_Monitor\mt5-monitor\backend\src\services\scheduler.js

# 配置文件
D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\ecosystem.config.js
→ C:\MT5_Monitor\mt5-monitor\backend\ecosystem.config.js

# 遷移腳本
D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\migrate-add-report-features.js
→ C:\MT5_Monitor\mt5-monitor\backend\migrate-add-report-features.js

D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\fix-commission-data.js
→ C:\MT5_Monitor\mt5-monitor\backend\fix-commission-data.js
```

#### 1.2 執行數據庫遷移

```powershell
cd C:\MT5_Monitor\mt5-monitor\backend

# 1. 修正舊的回佣數據
node fix-commission-data.js

# 2. 添加新功能的數據庫表和欄位
node migrate-add-report-features.js
```

#### 1.3 修改 ecosystem.config.js 配置

編輯 `C:\MT5_Monitor\mt5-monitor\backend\ecosystem.config.js`：

```javascript
env: {
  // ... 其他配置 ...
  
  // 定時上報時間設定（倫敦時間，cron 格式）
  REPORT_TIME_1: '45 23 * * *',  // 23:45
  REPORT_TIME_2: '0 10 * * *',   // 10:00
}
```

如需修改時間，使用 cron 格式：
- 格式：`分 時 日 月 星期`
- 例如：`30 14 * * *` = 每天 14:30

#### 1.4 重啟後端

```powershell
pm2 restart mt5-monitor-backend
pm2 logs mt5-monitor-backend
```

檢查日誌確認：
- `[Scheduler] Starting scheduled tasks...`
- `[Scheduler] Report time 1: 45 23 * * *`
- `[Scheduler] Report time 2: 0 10 * * *`

---

### 2. 前端部署

#### 2.1 複製文件到 VPS

```
# 刪除舊的 dist 文件夾
刪除: C:\MT5_Monitor\mt5-monitor\frontend\dist

# 複製新的 dist 文件夾
D:\OneDrive - VW\CascadeProjects\MT5_Monitor\frontend\dist
→ C:\MT5_Monitor\mt5-monitor\frontend\dist
```

#### 2.2 驗證前端

打開瀏覽器訪問：`http://your-vps-ip:8080`

檢查：
- 頂部有「要求MT5上報數據」按鈕（黃色）
- 總回佣顏色為淺藍色
- 點擊「要求MT5上報數據」按鈕，應該彈出「✓ 已發送上報請求給所有MT5」

---

### 3. MT5 EA 修改

#### 3.1 修改說明

參考文件：`D:\OneDrive - VW\CascadeProjects\MT5_Monitor\mql\MQL5_修改說明_主動上報功能.txt`

主要修改：
1. 添加 input 參數（2個）
2. 添加全局變量（2個）
3. 創建 `CheckReportRequest()` 函數
4. 在 `OnTick()` 中調用輪詢檢查
5. 修改數據發送邏輯，支持兩種模式
6. 添加場上手數計算和發送

#### 3.2 編譯和部署

1. 在 MetaEditor 中打開 `A計算盈虧_r9a_webmonitor.mq5`
2. 按照修改說明進行修改
3. 編譯（F7）
4. 複製 `.ex5` 文件到 MT5 的 `Experts` 文件夾
5. 重啟 EA

#### 3.3 EA 設置

在 MT5 中設置 EA 參數：
- `Report_Mode_OnDemand` = `true`（輪詢模式，推薦）
- `Report_Poll_Seconds` = `10`（每 10 秒檢查一次）
- `Commission_Per_Lot` = `2.0`（如果有回佣）

如果使用定時模式：
- `Report_Mode_OnDemand` = `false`
- 按原有的時間設定上報

---

## 功能測試

### 1. 測試手動上報

1. 打開 Web 界面
2. 點擊「要求MT5上報數據」按鈕
3. 等待 10 秒（MT5 輪詢間隔）
4. 檢查 MT5 日誌：應該看到「✓ 收到上報請求，準備發送數據」
5. 刷新 Web 頁面，數據應該更新

### 2. 測試定時上報

等待到設定的時間（23:45 或 10:00），檢查：
1. 後端日誌：`[Scheduler] Requesting report from all nodes`
2. MT5 日誌：「✓ 收到上報請求，準備發送數據」
3. Web 數據自動更新

### 3. 測試場上手數

1. 在 MT5 中開倉一些訂單
2. 觸發上報（手動或定時）
3. Web 上應該顯示橙色的場上手數

### 4. 測試顏色

檢查以下顏色是否正確：
- A手數總數：淺藍色（cyan-400）
- A總息：淺藍色（cyan-400）
- 總回佣：淺藍色（cyan-400）
- 場上手數：橙色（orange-400）

---

## API 端點

### 新增 API

1. **GET /api/report-request**
   - MT5 輪詢檢查是否有上報請求
   - 需要認證
   - 參數：`?id=node_id`
   - 返回：`{"ok": true, "requested": true/false}`

2. **POST /api/request-report**
   - Web 發送上報請求
   - 不需要認證
   - Body：`{"nodeId": "xxx"}` 或 `{}` (所有節點)
   - 返回：`{"ok": true, "message": "..."}`

---

## 數據庫變更

### 新增表

```sql
CREATE TABLE report_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    node_id TEXT,  -- NULL = all nodes
    requested_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    consumed_at DATETIME,
    FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
);
```

### 新增欄位

```sql
-- ab_stats 表
ALTER TABLE ab_stats ADD COLUMN open_lots REAL DEFAULT 0;
```

---

## 故障排除

### 問題 1：MT5 沒有收到上報請求

**檢查：**
1. MT5 EA 是否設置為輪詢模式（`Report_Mode_OnDemand = true`）
2. MT5 日誌是否有輪詢錯誤
3. 後端日誌是否有請求記錄
4. 數據庫中是否有 `report_requests` 記錄

**解決：**
```sql
-- 檢查數據庫
SELECT * FROM report_requests ORDER BY requested_at DESC LIMIT 10;
```

### 問題 2：定時任務沒有執行

**檢查：**
1. 後端日誌是否有 `[Scheduler] Starting scheduled tasks...`
2. `ecosystem.config.js` 中的時間設定是否正確
3. 服務器時區是否為倫敦時間

**解決：**
```powershell
# 重啟後端
pm2 restart mt5-monitor-backend
pm2 logs mt5-monitor-backend --lines 50
```

### 問題 3：場上手數顯示為 0

**檢查：**
1. MT5 是否有未平倉訂單
2. MT5 EA 是否正確計算場上手數
3. 數據庫中 `ab_stats.open_lots` 是否有值

**解決：**
```sql
-- 檢查數據庫
SELECT node_id, date, open_lots FROM ab_stats ORDER BY reported_at DESC LIMIT 10;
```

---

## 回滾方案

如果出現問題需要回滾：

1. **停止後端**
   ```powershell
   pm2 stop mt5-monitor-backend
   ```

2. **恢復數據庫**
   ```powershell
   # 找到備份文件
   dir C:\MT5_Monitor\data\*.backup*
   
   # 恢復（替換為實際的備份文件名）
   copy C:\MT5_Monitor\data\monitor.db.backup_xxx C:\MT5_Monitor\data\monitor.db
   ```

3. **恢復舊代碼**
   - 從備份恢復舊的後端文件
   - 從備份恢復舊的前端 dist 文件夾

4. **重啟後端**
   ```powershell
   pm2 restart mt5-monitor-backend
   ```

---

## 總結

本次更新添加了：
✅ MT5 主動上報功能（輪詢模式 + 定時模式）
✅ Web 手動要求上報按鈕
✅ 定時自動上報（23:45, 10:00）
✅ 場上手數顯示
✅ 顏色統一調整
✅ 回佣數據修正

部署完成後，系統將更加靈活，可以隨時要求 MT5 上報最新數據！
