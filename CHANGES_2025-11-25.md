# 2025-11-25 更新說明

## 修改內容

### 1. 收市時段離線通知優化

**問題**：每天 23:59 收市後沒有 tick，節點會離線並發送 TG 通知，但這是正常的市場關閉。

**解決方案**：
- 添加 `isMarketClosingTime()` 方法檢查是否在收市時段（23:55-01:05 倫敦時間）
- 在此時段內的離線不發送 TG 通知
- 適用於週一至週五的每日收市

**影響範圍**：
- `backend/src/services/heartbeat.js`

---

### 2. 交易日數據顯示邏輯修正

**問題**：
- MT5 在每天 23:45 發送當天的交易數據
- Web 應該在第二天顯示前一天收到的數據
- 原來使用 UTC `date('now')` 導致時區不一致

**解決方案**：
- 添加 `getCurrentTradingDate()` 方法
- 倫敦時間 00:00-01:30 之間顯示前一天的數據
- 01:30 之後顯示當天的數據
- 這樣在倫敦時間 00:00 時，仍然顯示前一天 23:45 收到的數據

**影響範圍**：
- `backend/src/database/db.js`
  - 修改 `getAllTodayABStats()` 使用交易日邏輯
  - 添加 `getCurrentTradingDate()` 方法
  - 添加 `getAllABStatsByDate(date)` 方法

---

### 3. 歷史快照數據修正

**問題**：
- 快照服務在 00:30 執行時，查詢數據使用了錯誤的日期邏輯
- 導致某些日期的快照沒有正確創建

**解決方案**：
- 快照服務使用新的 `getAllABStatsByDate(date)` 方法
- 明確指定要查詢的日期（前一天）
- 確保快照數據與實際交易日一致

**影響範圍**：
- `backend/src/services/snapshot.js`
  - 修改 `createDailySnapshot()` 使用指定日期查詢
  - 修改 `manualSnapshot()` 使用指定日期查詢

---

## 時間邏輯說明

### 交易日定義
- **倫敦時間 01:30** 是新交易日的開始
- **倫敦時間 00:00-01:30** 之間算前一天
- **倫敦時間 01:30-23:59** 之間算當天

### 收市時段定義
- **倫敦時間 23:55-01:05** 是收市時段
- 此時段內的離線不發送通知
- 跨越午夜（23:55-00:00 和 00:00-01:05）

### 快照時間
- **倫敦時間 00:30** 執行每日快照
- 保存前一天（23:45 收到的數據）的總覽

---

## 部署步驟

### 1. 複製後端文件到 VPS
```
D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\src\services\heartbeat.js
→ C:\MT5_Monitor\mt5-monitor\backend\src\services\heartbeat.js

D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\src\database\db.js
→ C:\MT5_Monitor\mt5-monitor\backend\src\database\db.js

D:\OneDrive - VW\CascadeProjects\MT5_Monitor\backend\src\services\snapshot.js
→ C:\MT5_Monitor\mt5-monitor\backend\src\services\snapshot.js
```

### 2. VPS 上重啟服務
```powershell
pm2 restart mt5-monitor-backend
pm2 logs mt5-monitor-backend --lines 30
```

### 3. 手動創建缺失的快照（如果需要）
```powershell
# 為 2025-11-24 創建快照
Invoke-WebRequest -Uri "http://localhost:8080/api/history/snapshot" `
  -Method POST -ContentType "application/json" `
  -Body '{"date":"2025-11-24"}'
```

---

## 驗證測試

### 1. 測試收市時段邏輯
在倫敦時間 23:55-01:05 之間：
- 節點離線應該不發送 TG 通知
- 日誌應該顯示：`[收市時段] 節點 xxx 在收市時段離線（23:55-01:05），跳過 TG 通知`

### 2. 測試交易日顯示
- 在倫敦時間 00:00-01:30 之間，Web 應該顯示前一天的數據
- 在倫敦時間 01:30 之後，Web 應該顯示當天的數據

### 3. 測試歷史快照
- 訪問 `https://mon1.win/` → 歷史數據頁
- 應該能看到 2025-11-22 和 2025-11-24 的數據
- 如果沒有 11-24 的數據，手動創建快照

---

## 日誌關鍵字

監控以下日誌確認功能正常：

```
[收市時段] 節點 xxx 在收市時段離線（23:55-01:05），跳過 TG 通知
[Snapshot] Creating daily snapshot for YYYY-MM-DD
[Snapshot] Daily snapshot created successfully
```

---

## 注意事項

1. **時區一致性**：所有時間邏輯都使用倫敦時間（Europe/London），自動處理夏令時
2. **數據完整性**：如果發現歷史數據缺失，可以使用手動快照 API 補充
3. **通知優化**：收市時段和周末的離線都不會發送通知，減少誤報

---

## 未來優化建議

1. 考慮添加節假日判斷（市場休市日）
2. 可以記錄收市時段的離線次數，用於統計分析
3. 考慮添加數據自動補全機制
