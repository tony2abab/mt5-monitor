/* MQL4/MQL5 codes was generated by Forex-EABuilder 
 Author: Dennis 
 Date: Mon Nov 17 2025 21:49:04 GMT+0800
 整合網頁監控版本 v9.02
 */ 

#include <ChartObjects\ChartObjectsTxtControls.mqh>
#include <Controls\Label.mqh>
#include <Controls\Button.mqh>
#include <Controls\Edit.mqh>

#property copyright "Forex-EABuilder + Web Monitor"
#property link "http://www.forex-eabuilder.com"
#property version "9.02"
#property description "A計算盈虧_r9a A要求開始 MT5 + 網頁監控"
#property strict

input  string  檔案頭ID = "A1";
input  string  備註_VPS位置 = "VPS0";
input  int  每日最大統計次數_要x2 = 200;
input  double  當港幣時轉換匯率 = 7.78;
input  string  __________TG及通知有關__________ = "=====TG及通知有關=====";
input  bool  TG通知1_每天成本打開 = true;
input  string  TG1_Token_每天成本 = "bot7920839003:AAE9OP_FVWLEw6d46l8qEg6eiGmlKeiKYBo";
input  string  TG1_ChatID_每天成本 = "7482711333";
input  bool  TG1_手數不相等時星星備注_打開 = true;
input  bool  TG通知2_每手成本過高警報 = true;
input  string  TG2_Token_警報 = "bot6492162382:AAEKsQWDUXc7cJw0pS1z_lqsHZ6HIFLpjpw";
input  string  TG2_ChatID_警報 = "1942176657";
input  string  TG_Link = "https://api.telegram.org";
input  int  每日TG通知盈虧 = 1;
input  int  Step4_IC時 = 23;
input  int  Step4_IC分_0to58 = 33;
input  double  每手成本超過多少通知 = -20;

// ==================== 網頁監控參數 ====================
input  string  __________網頁監控系統__________ = "=====網頁監控參數=====";
input  string  Monitor_API_URL = "http://192.168.31.206:8080/api";
input  string  Monitor_API_KEY = "secret_key_2025_9093942525abcdxyz_";
input  string  Monitor_NodeID = "A1_VPS0";
input  int  Monitor_HeartbeatMinutes = 15;
input  bool  Monitor_AutoSend = true;
input  bool  Monitor_OnlyHeartbeat = false;  // 只發送心跳，不發送統計數據

CChartObjectRectLabel m_rect1;

void object_Create_Rect(CChartObjectRectLabel  *objectRect, string object_name, const ENUM_BASE_CORNER argCorner, int x1, int y1, int rect_width, int rect_height, color arglinecolor) {
    if(!objectRect.Create(0,object_name,0,x1,y1,rect_width,rect_height))
      return;
    objectRect.BackColor(arglinecolor);
    ObjectSetInteger(0,object_name,OBJPROP_CORNER,argCorner);
}

CLabel m_label21;

void object_label_create(CLabel *argLabel,  string label_name, string label_text, const ENUM_BASE_CORNER argCorner, int x1, int y1, int fontsize, color argFontColor, string argFontType) {
    int x2=x1;
    int y2=y1+(fontsize*2);
    if(!argLabel.Create(0,label_name,0,x1,y1,x2,y2))
      return;
    if(!argLabel.Text(label_text))
      return;
    if(!argLabel.Color(argFontColor))
      return;
    if(!argLabel.FontSize(fontsize))
      return;
    if(!argLabel.Font(argFontType))
      return;
    ObjectSetInteger(0,label_name,OBJPROP_CORNER,argCorner);
}

CLabel m_label22;
CLabel m_label1;
CLabel m_label2;
CLabel m_label3;
CLabel m_label25;
CLabel m_label4;
CLabel m_label5;
CLabel m_label6;
CLabel m_label7;
CLabel m_label8;
CLabel m_label9;

int get_time_info_hour(datetime argTime)
{
      MqlDateTime tm_;
      TimeToStruct(argTime, tm_);
     return (tm_.hour);
}

CLabel m_label10;
CLabel m_label11;
CLabel m_label12;
CLabel m_label13;
CLabel m_label14;
CButton m_button1;

void object_Create_Buttons(CButton *objectButton, string button_name, string button_text, const ENUM_BASE_CORNER argCorner, int x1, int y1, int text_width, int fontsize, color text_color, color bg_color, string argFontType) {
    int x2=x1+text_width;
    int y2=y1+(fontsize*3);
    if(!objectButton.Create(0,button_name,0,x1,y1,x2,y2))
      return;
    if(!objectButton.Text(button_text))
      return;
    if(!objectButton.Color(text_color))
      return;
    if(!objectButton.ColorBackground(bg_color))
      return;
    if(!objectButton.FontSize(fontsize))
      return;
    if(!objectButton.Font(argFontType))
      return;
    ObjectSetInteger(0,button_name,OBJPROP_CORNER,argCorner);
}

CButton m_button2;
CButton m_button3;
CButton m_button11;
CButton m_button12;
CEdit m_edit1;

void object_Create_Edit(CEdit *objectEdit, string object_name, const ENUM_BASE_CORNER argCorner, int x1, int y1, int edit_width, int fontsize, color text_color, color bg_color, string argFontType) {
    int x2=x1+edit_width;
    int y2=y1+(fontsize*3);
    if(!objectEdit.Create(0,object_name,0,x1,y1,x2,y2))
      return;
     if(!objectEdit.Text(""))
      return;
    if(!objectEdit.ReadOnly(false))
      return;
    if(!objectEdit.Color(text_color))
      return;
    if(!objectEdit.ColorBackground(bg_color))
      return;
    if(!objectEdit.FontSize(fontsize))
      return;
    if(!objectEdit.TextAlign(ALIGN_RIGHT))
      return;
    if(!objectEdit.Font(argFontType))
      return;
    ObjectSetInteger(0,object_name,OBJPROP_CORNER,argCorner);
}

CEdit m_edit2;
CEdit m_edit3;
CEdit m_edit4;
CEdit m_edit5;
CEdit m_edit6;
CEdit m_edit7;
CEdit m_edit8;
CEdit m_edit9;
CEdit m_edit10;

void object_update_edit(CEdit *objectEdit, string edit_text_, string argFontType) {
    if(!objectEdit.Text(edit_text_))
      return;
    if(!objectEdit.Font(argFontType))
      return;
}

void object_update_buttons(CButton *objectButton, color text_color, color bg_color, string argFontType) {
    if(!objectButton.Color(text_color))
      return;
    if(!objectButton.ColorBackground(bg_color))
      return;
    if(!objectButton.Font(argFontType))
      return;
}

void OnChartEvent(const int id,const long &lparam,const double &dparam,const string &sparam) {

       if(m_button1.Pressed()) {
    開始 = 1;
    object_update_buttons(&m_button1,0xffffff,0x0099ff,"Arial");
    m_label2.Text((string("A總手數 : ") + string("")));
    m_label2.Color(0xffffff);
    m_label2.Font("Calibri");
    m_label3.Text((string("A總盈利 : ") + string("")));
    m_label3.Color(0xffffff);
    m_label3.Font("Calibri");
    m_label4.Text((string("B總手數 : ") + string("")));
    m_label4.Color(0xffffff);
    m_label4.Font("Calibri");
    m_label5.Text((string("B總盈利 : ") + string("")));
    m_label5.Color(0xffffff);
    m_label5.Font("Calibri");
    m_label6.Text((string("A與B的手數差 : ") + string("")));
    m_label6.Color(0xffffff);
    m_label6.Font("Calibri");
    m_label7.Text((string("A+B的總盈利 : ") + string("")));
    m_label7.Color(0xffffff);
    m_label7.Font("Calibri");
    m_label8.Text((string("每手成本US$ : ") + string("")));
    m_label8.Color(0xffffff);
    m_label8.Font("Calibri");
    m_button1.Pressed(false);
  }
   if(m_button2.Pressed()) {
    今天 = 1;
    object_update_buttons(&m_button2,0xffffff,0x0099ff,"Arial");
    m_button2.Pressed(false);
  }
   if(m_button3.Pressed()) {
    Step4時間已進入3 = 0;
    Step4時間已進入2 = 0;
    Step4時間已進入1 = 1;
    object_update_buttons(&m_button3,0xffffff,0x0099ff,"Arial");
    m_button3.Pressed(false);
  }
   if(m_button11.Pressed()) {
    GMT1_日月();
    GMT按鈕狀態 = 1;
    檔名_GMT按鈕_write = FileOpen(input_檔名_GMT按鈕, FILE_CSV|FILE_WRITE|FILE_READ|FILE_COMMON|FILE_ANSI, " ");
    FileWrite(檔名_GMT按鈕_write,1);
    FileClose(檔名_GMT按鈕_write);
    object_update_edit(&m_edit4,string(1),"Calibri");
    object_update_edit(&m_edit5,string(0),"Calibri");
    object_update_edit(&m_edit9,string(23),"Calibri");
    object_update_edit(&m_edit10,string(59),"Calibri");
    S4_時_變數 = Step4_IC時;
    m_button11.Pressed(false);
  }
   if(m_button12.Pressed()) {
    GMT2_日月();
    GMT按鈕狀態 = 2;
    檔名_GMT按鈕_write = FileOpen(input_檔名_GMT按鈕, FILE_CSV|FILE_WRITE|FILE_READ|FILE_COMMON|FILE_ANSI, " ");
    FileWrite(檔名_GMT按鈕_write,2);
    FileClose(檔名_GMT按鈕_write);
    if (是夏令時間 == 1) {
      Print((string("初始 是夏令時間 = ") + string(是夏令時間)));
      object_update_edit(&m_edit4,string(22),"Calibri");
      object_update_edit(&m_edit5,string(0),"Calibri");
      object_update_edit(&m_edit9,string(20),"Calibri");
      object_update_edit(&m_edit10,string(58),"Calibri");

    } else {
      Print((string("初始 是夏令時間 = ") + string(是夏令時間)));
      object_update_edit(&m_edit4,string(23),"Calibri");
      object_update_edit(&m_edit5,string(0),"Calibri");
      object_update_edit(&m_edit9,string(21),"Calibri");
      object_update_edit(&m_edit10,string(58),"Calibri");

    }
    if (是夏令時間 == 1) {
      S4_時_變數 = Step4_IC時 - 3;

    } else {
      S4_時_變數 = Step4_IC時 - 2;

    }
    m_button12.Pressed(false);
  }

    ChartRedraw();

}

bool week_enable1111111S4_時_變數Step4_IC分_0to58S4_時_變數S4_分加一[7] = {true, true, true, true, true, true, true};

bool Check_TimeSession(bool &weekday_enable[],int aStartHour,int aStartMinute,int aStopHour,int aStopMinute,datetime aTimeCur)
 {
     MqlDateTime  TimeSession;
     TimeToStruct(aTimeCur, TimeSession);
     int day_of_week_ = TimeSession.day_of_week;
     if(weekday_enable[day_of_week_] == false)
         return false;
   int StartTime =3600 * aStartHour + 60 * aStartMinute;
   int StopTime = 3600*aStopHour+60*aStopMinute;
   aTimeCur = aTimeCur % 86400;
   if(StopTime<StartTime)
   {
       if(aTimeCur>=StartTime || aTimeCur<StopTime)
       {
         return(true);
       }
     }
     else
     {
       if(aTimeCur>=StartTime && aTimeCur<StopTime)
       {
          return(true);
       }
     }
     return(false);
}

ulong get_history_deal_ticket_by_position(int argPositionNumber) {
   ulong deal_ticket;
   int deals;
   datetime end=TimeCurrent();
   datetime start=0;
   HistorySelect(start,end);
   deals = HistoryDealsTotal();
   if(deals > 0) {
      deal_ticket=HistoryDealGetTicket(deals-argPositionNumber);
      if(HistoryDealSelect(deal_ticket))
         return deal_ticket;
      else
         return 0;
   }
   return 0;
 }

int get_history_trades_total_deal() {
   int deals;
   datetime end=TimeCurrent();
   datetime start=0;
   HistorySelect(start,end);
   deals = HistoryDealsTotal();
   return deals;
 }

long get_history_property_integer_by_deal_ticket(long argTicket, ENUM_DEAL_PROPERTY_INTEGER argTypeInfo) {
   int deals;
   datetime end=TimeCurrent();
   datetime start=0;
   HistorySelect(start,end);
   deals = HistoryDealsTotal();
   if(deals > 0) {
      if(HistoryDealSelect(argTicket))
            return HistoryDealGetInteger(argTicket, argTypeInfo);
   }
   return 0;
 }

datetime convert_to_datetime(int argYear, int argMonth, int argDay, int argHour, int argMinu)
{
     string spec_time = string(argYear)+"."+string(argMonth)+"."+string(argDay)+" "+string(argHour)+":"+string(argMinu);
     datetime spec_datetime = StringToTime(spec_time);
     return(spec_datetime);
}

string get_history_property_string_by_deal_ticket(long argTicket, ENUM_DEAL_PROPERTY_STRING argTypeInfo) {
   int deals;
   datetime end=TimeCurrent();
   datetime start=0;
   HistorySelect(start,end);
   deals = HistoryDealsTotal();
   if(deals > 0) {
      if(HistoryDealSelect(argTicket))
           return HistoryDealGetString(argTicket, argTypeInfo);
   }
   return "";
 }

double get_history_property_double_by_deal_ticket(ulong argTicket, ENUM_DEAL_PROPERTY_DOUBLE argTypeInfo) {
   int deals;
   datetime end=TimeCurrent();
   datetime start=0;
   HistorySelect(start,end);
   deals = HistoryDealsTotal();
   if(deals > 0) {
      if(HistoryDealSelect(argTicket))
         return HistoryDealGetDouble(argTicket, argTypeInfo);
   }
   return 0;
 }

//+------------------------------------------------------------------+
//| 網頁監控 - 發送心跳                                               |
//+------------------------------------------------------------------+
void SendMonitorHeartbeat() {
   string url = Monitor_API_URL + "/heartbeat";
   string headers = "Content-Type: application/json\r\nAuthorization: Bearer " + Monitor_API_KEY + "\r\n";
   string broker = AccountInfoString(ACCOUNT_COMPANY);
   string account = IntegerToString(AccountInfoInteger(ACCOUNT_LOGIN));
   string payload = "{\"id\":\"" + Monitor_NodeID + "\",\"name\":\"" + 檔案頭ID + " " + 備註_VPS位置 + "\",\"broker\":\"" + broker + "\",\"account\":\"" + account + "\"}";
   char post_data[], result[];
   string result_headers;
   StringToCharArray(payload, post_data, 0, StringLen(payload));
   ResetLastError();
   int res = WebRequest("POST", url, headers, 5000, post_data, result, result_headers);
   if(res == 200 || res == 201) {
      g_lastMonitorHeartbeat = TimeCurrent();
      Print("✓ 網頁監控心跳成功");
   } else {
      int error_code = GetLastError();
      Print("✗ 監控心跳失敗 HTTP:", res, " Error:", error_code);
      if(error_code == 4014) Print("  請將網址加入白名單: ", Monitor_API_URL);
   }
}

//+------------------------------------------------------------------+
//| 網頁監控 - 發送 A/B 統計                                          |
//+------------------------------------------------------------------+
void SendMonitorABStats() {
   if(!Monitor_AutoSend) return;
   string url = Monitor_API_URL + "/ab-stats";
   string headers = "Content-Type: application/json\r\nAuthorization: Bearer " + Monitor_API_KEY + "\r\n";
   double lots_diff = A手數總數 - B手數總數;
   double a_profit_usd = A盈利總數 / 匯率變數;
   double ab_total = a_profit_usd + B盈利總數;
   double cost_per_lot = (A手數總數 > 0) ? (ab_total / A手數總數) : 0;
   MqlDateTime tm;
   TimeToStruct(TimeCurrent(), tm);
   string today_date = StringFormat("%04d-%02d-%02d", tm.year, tm.mon, tm.day);
   string payload = "{\"id\":\"" + Monitor_NodeID + "\",\"date\":\"" + today_date + "\",";
   payload += "\"a_lots_total\":" + DoubleToString(A手數總數, 2) + ",";
   payload += "\"b_lots_total\":" + DoubleToString(B手數總數, 2) + ",";
   payload += "\"lots_diff\":" + DoubleToString(lots_diff, 2) + ",";
   payload += "\"a_profit_total\":" + DoubleToString(a_profit_usd, 2) + ",";
   payload += "\"b_profit_total\":" + DoubleToString(B盈利總數, 2) + ",";
   payload += "\"ab_profit_total\":" + DoubleToString(ab_total, 2) + ",";
   payload += "\"a_interest_total\":" + DoubleToString(A總息, 2) + ",";
   payload += "\"cost_per_lot\":" + DoubleToString(cost_per_lot, 2) + "}";
   char post_data[], result[];
   string result_headers;
   StringToCharArray(payload, post_data, 0, StringLen(payload));
   ResetLastError();
   int res = WebRequest("POST", url, headers, 5000, post_data, result, result_headers);
   if(res == 200 || res == 201) {
      g_dataSentToday = true;
      Print("✓ A/B統計發送成功");
      Print("  A手數:", A手數總數, " B手數:", B手數總數);
      Print("  AB總盈利:", ab_total, " 每手成本:", cost_per_lot);
   } else {
      Print("✗ 統計發送失敗 HTTP:", res, " Error:", GetLastError());
   }
}
