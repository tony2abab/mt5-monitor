/* MQL4/MQL5 codes was generated by Forex-EABuilder 
 Author: Dennis 
 Date: Mon Nov 17 2025 10:32:57 GMT+0800
 Modified: Added Web Monitor功能 (心跳 + 統計上報)
 */ 

#include <ChartObjects\ChartObjectsTxtControls.mqh>
#include <Controls\Label.mqh>
#include <Controls\Button.mqh>
#include <Controls\Edit.mqh>

#property copyright "Forex-EABuilder + WebMonitor"
#property link "http://www.forex-eabuilder.com"
#property version "9.02"
#property description "A計算盈虧_r9a A要求開始 MT4 + WebMonitor"
#property strict

// ========== 新增：浮點數比較容差 ==========
#define LOTS_TOLERANCE 0.001  // 手數容差 0.001

// ========== 原有參數 ==========
input  string  檔案頭ID = "A1";
input  string  備註_VPS位置 = "VPS0";
input  int  每日最大統計次數_要x2 = 200;
input  double  當港幣時轉換匯率 = 7.78;
input  string  __________TG及通知有關__________ = "=====TG及通知有關=====";
input  bool  TG通知1_每天成本打開 = true;
input  string  TG1_Token_每天成本 = "bot7920839003:AAE9OP_FVWLEw6d46l8qEg6eiGmlKeiKYBo";
input  string  TG1_ChatID_每天成本 = "7482711333";
input  bool  TG1_手數不相等時星星備注_打開 = true;
input  bool  TG通知2_每手成本過高警報 = true;
input  string  TG2_Token_警報 = "bot6492162382:AAEKsQWDUXc7cJw0pS1z_lqsHZ6HIFLpjpw";
input  string  TG2_ChatID_警報 = "1942176657";
input  string  TG_Link = "https://api.telegram.org";
input  int  每日TG通知盈虧 = 0;
input  int  Step4_IC時 = 23;
input  int  Step4_IC分_0to58 = 33;
input  double  每手成本超過多少通知 = -20;

// ========== 新增：WebMonitor 參數 ==========
input  string  __________WebMonitor設定__________ = "=====WebMonitor設定=====";
input  string  API_BASE_URL = "https://api.mon1.win/api";  // API 服務器地址
input  string  API_KEY = "secret_key_2025_9093942525abcdxyz_";        // API 驗證密鑰
input  string  ClientGroup = "A";                            // 客戶分組 (A, B, C...)
input  double  Commission_Per_Lot = 2.0;                    // 每手回佣
input  bool    Print_Heartbeat_Success = false;             // 打印心跳成功訊息
input  int     HeartbeatIntervalMinutes = 5;                // 心跳間隔（分鐘）
// 上報模式設定
input  bool    Report_Mode_OnDemand = true;                 // true=輪詢模式(等待Web請求), false=定時模式
input  int     Report_Poll_Seconds = 60;                    // 輪詢間隔(秒)
input  int     StatsReportHour = 23;                        // 統計上報時間-小時
input  int     StatsReportMinute = 45;                      // 統計上報時間-分鐘
input  bool    Monitor_OnlyHeartbeat = false;               // 只發送心跳，不發送統計數據
input  bool    EnableDebugLog = true;                       // 啟用詳細日誌

// ========== GUI 物件宣告 ==========
CChartObjectRectLabel m_rect1;
CLabel m_label21;
CLabel m_label22;
CLabel m_label1;
CLabel m_label2;
CLabel m_label3;
CLabel m_label25;
CLabel m_label4;
CLabel m_label5;
CLabel m_label6;
CLabel m_label7;
CLabel m_label8;
CLabel m_label9;
CLabel m_label10;
CLabel m_label11;
CLabel m_label12;
CLabel m_label13;
CLabel m_label14;
CButton m_button1;
CButton m_button2;
CButton m_button3;
CButton m_button11;
CButton m_button12;
CButton m_button13;
CButton m_button14;
CButton m_button15;
CEdit m_edit1;
CEdit m_edit2;
CEdit m_edit3;
CEdit m_edit4;
CEdit m_edit5;
CEdit m_edit6;
CEdit m_edit7;
CEdit m_edit8;
CEdit m_edit9;
CEdit m_edit10;

// ========== GUI 函式 ==========
void object_Create_Rect(CChartObjectRectLabel  *objectRect, string object_name, const ENUM_BASE_CORNER argCorner, int x1, int y1, int rect_width, int rect_height, color arglinecolor) {
    if(!objectRect.Create(0,object_name,0,x1,y1,rect_width,rect_height))
      return;
    objectRect.BackColor(arglinecolor);
    ObjectSetInteger(0,object_name,OBJPROP_CORNER,argCorner);
}

void object_label_create(CLabel *argLabel,  string label_name, string label_text, const ENUM_BASE_CORNER argCorner, int x1, int y1, int fontsize, color argFontColor, string argFontType) {
    int x2=x1;
    int y2=y1+(fontsize*2);
    if(!argLabel.Create(0,label_name,0,x1,y1,x2,y2))
      return;
    if(!argLabel.Text(label_text))
      return;
    if(!argLabel.Color(argFontColor))
      return;
    if(!argLabel.FontSize(fontsize))
      return;
    if(!argLabel.Font(argFontType))
      return;
    ObjectSetInteger(0,label_name,OBJPROP_CORNER,argCorner);
}

void object_Create_Buttons(CButton *objectButton, string button_name, string button_text, const ENUM_BASE_CORNER argCorner, int x1, int y1, int text_width, int fontsize, color text_color, color bg_color, string argFontType) {
    int x2=x1+text_width;
    int y2=y1+(fontsize*3);
    if(!objectButton.Create(0,button_name,0,x1,y1,x2,y2))
      return;
    if(!objectButton.Text(button_text))
      return;
    if(!objectButton.Color(text_color))
      return;
    if(!objectButton.ColorBackground(bg_color))
      return;
    if(!objectButton.FontSize(fontsize))
      return;
    if(!objectButton.Font(argFontType))
      return;
    ObjectSetInteger(0,button_name,OBJPROP_CORNER,argCorner);
}

void object_Create_Edit(CEdit *objectEdit, string object_name, const ENUM_BASE_CORNER argCorner, int x1, int y1, int edit_width, int fontsize, color text_color, color bg_color, string argFontType) {
    int x2=x1+edit_width;
    int y2=y1+(fontsize*3);
    if(!objectEdit.Create(0,object_name,0,x1,y1,x2,y2))
      return;
     if(!objectEdit.Text(""))
      return;
    if(!objectEdit.ReadOnly(false))
      return;
    if(!objectEdit.Color(text_color))
      return;
    if(!objectEdit.ColorBackground(bg_color))
      return;
    if(!objectEdit.FontSize(fontsize))
      return;
    if(!objectEdit.TextAlign(ALIGN_RIGHT))
      return;
    if(!objectEdit.Font(argFontType))
      return;
    ObjectSetInteger(0,object_name,OBJPROP_CORNER,argCorner);
}

void object_update_edit(CEdit *objectEdit, string edit_text_, string argFontType) {
    if(!objectEdit.Text(edit_text_))
      return;
    if(!objectEdit.Font(argFontType))
      return;
}

void object_update_buttons(CButton *objectButton, color text_color, color bg_color, string argFontType) {
    if(!objectButton.Color(text_color))
      return;
    if(!objectButton.ColorBackground(bg_color))
      return;
    if(!objectButton.Font(argFontType))
      return;
}

void OnChartEvent(const int id,const long &lparam,const double &dparam,const string &sparam) {
    if(m_button1.Pressed()) {
        開始 = 1;
        object_update_buttons(&m_button1,0xffffff,0x0099ff,"Arial");
        m_label2.Text((string("A總手數 : ") + string("")));
        m_label2.Color(0xffffff);
        m_label2.Font("Calibri");
        m_label3.Text((string("A總盈利 : ") + string("")));
        m_label3.Color(0xffffff);
        m_label3.Font("Calibri");
        m_label4.Text((string("B總手數 : ") + string("")));
        m_label4.Color(0xffffff);
        m_label4.Font("Calibri");
        m_label5.Text((string("B總盈利 : ") + string("")));
        m_label5.Color(0xffffff);
        m_label5.Font("Calibri");
        m_label6.Text((string("A與B的手數差 : ") + string("")));
        m_label6.Color(0xffffff);
        m_label6.Font("Calibri");
        m_label7.Text((string("A+B的總盈利 : ") + string("")));
        m_label7.Color(0xffffff);
        m_label7.Font("Calibri");
        m_label8.Text((string("每手成本US$ : ") + string("")));
        m_label8.Color(0xffffff);
        m_label8.Font("Calibri");
        m_button1.Pressed(false);
    }
    if(m_button2.Pressed()) {
        今天 = 1;
        object_update_buttons(&m_button2,0xffffff,0x0099ff,"Arial");
        m_button2.Pressed(false);
    }
    if(m_button3.Pressed()) {
        Step4時間已進入3 = 0;
        Step4時間已進入2 = 0;
        Step4時間已進入1 = 1;
        object_update_buttons(&m_button3,0xffffff,0x0099ff,"Arial");
        m_button3.Pressed(false);
    }
    if(m_button11.Pressed()) {
        GMT1_日月();
        GMT按鈕狀態 = 1;
        檔名_GMT按鈕_write = FileOpen(input_檔名_GMT按鈕, FILE_CSV|FILE_WRITE|FILE_READ|FILE_COMMON|FILE_ANSI, " ");
        FileWrite(檔名_GMT按鈕_write,1);
        FileClose(檔名_GMT按鈕_write);
        object_update_edit(&m_edit4,string(1),"Calibri");
        object_update_edit(&m_edit5,string(0),"Calibri");
        object_update_edit(&m_edit9,string(23),"Calibri");
        object_update_edit(&m_edit10,string(59),"Calibri");
        S4_時_變數 = Step4_IC時;
        m_button11.Pressed(false);
    }
    if(m_button12.Pressed()) {
        GMT2_日月();
        GMT按鈕狀態 = 2;
        檔名_GMT按鈕_write = FileOpen(input_檔名_GMT按鈕, FILE_CSV|FILE_WRITE|FILE_READ|FILE_COMMON|FILE_ANSI, " ");
        FileWrite(檔名_GMT按鈕_write,2);
        FileClose(檔名_GMT按鈕_write);
        if (是夏令時間 == 1) {
            Print((string("初始 是夏令時間 = ") + string(是夏令時間)));
            object_update_edit(&m_edit4,string(22),"Calibri");
            object_update_edit(&m_edit5,string(0),"Calibri");
            object_update_edit(&m_edit9,string(20),"Calibri");
            object_update_edit(&m_edit10,string(58),"Calibri");
        } else {
            Print((string("初始 是夏令時間 = ") + string(是夏令時間)));
            object_update_edit(&m_edit4,string(23),"Calibri");
            object_update_edit(&m_edit5,string(0),"Calibri");
            object_update_edit(&m_edit9,string(21),"Calibri");
            object_update_edit(&m_edit10,string(58),"Calibri");
        }
        if (是夏令時間 == 1) {
            S4_時_變數 = Step4_IC時 - 3;
        } else {
            S4_時_變數 = Step4_IC時 - 2;
        }
        m_button12.Pressed(false);
    }
    if(m_button13.Pressed()) {
        GMT3_日月();
        GMT按鈕狀態 = 3;
        檔名_GMT按鈕_write = FileOpen(input_檔名_GMT按鈕, FILE_CSV|FILE_WRITE|FILE_READ|FILE_COMMON|FILE_ANSI, " ");
        FileWrite(檔名_GMT按鈕_write,3);
        FileClose(檔名_GMT按鈕_write);
        if (是夏令時間 == 1) {
            Print((string("初始 是夏令時間 = ") + string(是夏令時間)));
            object_update_edit(&m_edit4,string(6),"Calibri");
            object_update_edit(&m_edit5,string(0),"Calibri");
            object_update_edit(&m_edit9,string(5),"Calibri");
            object_update_edit(&m_edit10,string(0),"Calibri");
        } else {
            Print((string("初始 是夏令時間 = ") + string(是夏令時間)));
            object_update_edit(&m_edit4,string(7),"Calibri");
            object_update_edit(&m_edit5,string(0),"Calibri");
            object_update_edit(&m_edit9,string(6),"Calibri");
            object_update_edit(&m_edit10,string(0),"Calibri");
        }
        if (是夏令時間 == 1) {
            S4_時_變數 = Step4_IC時 - 19;
        } else {
            S4_時_變數 = Step4_IC時 - 18;
        }
        m_button13.Pressed(false);
    }
    if(m_button14.Pressed()) {
        GMT按鈕狀態 = 4;
        檔名_GMT按鈕_write = FileOpen(input_檔名_GMT按鈕, FILE_CSV|FILE_WRITE|FILE_READ|FILE_COMMON|FILE_ANSI, " ");
        FileWrite(檔名_GMT按鈕_write,4);
        FileClose(檔名_GMT按鈕_write);
        m_button14.Pressed(false);
    }
    if(m_button15.Pressed()) {
        測試TG通知 = 1;
        object_update_buttons(&m_button15,0xffffff,0x0099ff,"Arial");
        m_button15.Pressed(false);
    }
    ChartRedraw();
}

// ========== 原有工具函式 ==========
bool week_enable1111111S4_時_變數Step4_IC分_0to58S4_時_變數S4_分加一[7] = {true, true, true, true, true, true, true};

bool Check_TimeSession(bool &weekday_enable[],int aStartHour,int aStartMinute,int aStopHour,int aStopMinute,datetime aTimeCur) {
    int day_of_week_ = TimeDayOfWeek(aTimeCur);
    if(weekday_enable[day_of_week_] == false)
        return false;
    int StartTime =3600 * aStartHour + 60 * aStartMinute;
    int StopTime = 3600*aStopHour+60*aStopMinute;
    aTimeCur = aTimeCur % 86400;
    if(StopTime<StartTime) {
        if(aTimeCur>=StartTime || aTimeCur<StopTime) {
            return(true);
        }
    } else {
        if(aTimeCur>=StartTime && aTimeCur<StopTime) {
            return(true);
        }
    }
    return(false);
}

int get_history_ticket_by_position(int argPositionNumber) {
    int nPos=0;
    int history_trade_total=HistoryTotal();
    if(history_trade_total > 0)
        if(OrderSelect(history_trade_total - argPositionNumber,SELECT_BY_POS,MODE_HISTORY)==true) {
            return OrderTicket();
        }
    return 0;
}

int get_history_int_by_ticket(int argTicket, int argTypeInfo) {
    int history_trade_total=HistoryTotal();
    if(history_trade_total > 0)
        if(OrderSelect(argTicket ,SELECT_BY_TICKET,MODE_HISTORY)==true) {
            switch (argTypeInfo) {
                case 0:
                    return (int)OrderOpenTime();
                case 1:
                    return (int)OrderCloseTime();
                case 2:
                    return OrderMagicNumber();
            }
        }
    return 0;
}

datetime convert_to_datetime(int argYear, int argMonth, int argDay, int argHour, int argMinu) {
    string spec_time = string(argYear)+"."+string(argMonth)+"."+string(argDay)+" "+string(argHour)+":"+string(argMinu);
    datetime spec_datetime = StringToTime(spec_time);
    return(spec_datetime);
}

string get_history_string_by_ticket(int argTicket, int argTypeInfo) {
    int history_trade_total=HistoryTotal();
    if(history_trade_total > 0)
        if(OrderSelect(argTicket ,SELECT_BY_TICKET,MODE_HISTORY)==true) {
            switch (argTypeInfo) {
                case 0:
                    return OrderSymbol();
                case 1:
                    return OrderComment();
            }
        }
    return "";
}

double get_history_double_by_ticket(int argTicket, int argTypeInfo) {
    int history_trade_total=HistoryTotal();
    if(history_trade_total > 0) {
        if(OrderSelect(argTicket ,SELECT_BY_TICKET,MODE_HISTORY)==true) {
            switch (argTypeInfo) {
                case 0:
                    return OrderLots();
                case 1:
                    return OrderOpenPrice();
                case 2:
                    return OrderStopLoss();
                case 3:
                    return OrderTakeProfit();
                case 4:
                    return OrderClosePrice();
                case 5:
                    return OrderSwap();
                case 6:
                    return OrderProfit();
                case 7:
                    return OrderCommission();
            }
        }
    }
    return 0;
}

void telegram_push_messages_(string telegram_token, string telegram_chatid, string telegram_messages) {
    int    res;
    char   data[];
    string headers="";
    string  str;
    str = "chat_id="+telegram_chatid+"&text="+telegram_messages;
    ArrayResize(data,StringToCharArray(str,data,0,WHOLE_ARRAY, CP_UTF8)-1);
    string requestLine = "https://api.telegram.org/"+telegram_token+"/sendMessage";
    res=WebRequest("POST",requestLine,headers,0,data,data,str);
    if(res!=200)
        Print("Authorization error #"+(string)res+", LastError="+(string)GetLastError());
    return;
}

// ========== 原有全域變數 ==========
int  檔案代碼 = 0;
ulong  迴圈成交單號 = 0;
int  開始 = 0;
double  A盈利總數 = 0;
double  A手數總數 = 0;
double  B盈利總數 = 0;
double  B手數總數 = 0;
int  開始_年 = 0;
int  開始_月 = 0;
int  開始_日 = 0;
int  開始_時_變數 = 0;
int  開始_分_變數 = 0;
int  Kbar數2 = 0;
double  檔名_手數_write = 0;
double  檔名_盈利_write = 0;
string  input_檔名_手數 = "";
string  input_檔名_盈利 = "";
double  匯率變數 = 0;
int  結束_年 = 0;
int  結束_月 = 0;
int  結束_日 = 0;
int  結束_時_變數 = 0;
int  結束_分_變數 = 0;
int  GMT按鈕狀態 = 1;
double  檔名_GMT按鈕_write = 0;
string  input_檔名_GMT按鈕 = "";
double  檔名_A要求開始_write = 0;
string  input_檔名_A要求開始 = "";
int  A要求開始_狀態 = 0;
int  今天 = 0;
int  已發出TG通知1 = 0;
int  S4_時_變數 = 0;
int  S4_分加一 = 0;
int  Step4時間已進入1 = 0;
int  Step4時間已進入2 = 0;
int  Step4時間已進入3 = 0;
int  是夏令時間 = 1;
int  測試TG通知 = 0;
double  A總息 = 0;

// ========== 新增：WebMonitor 全域變數 ==========
datetime g_lastHeartbeat = 0;
datetime g_lastStatsReport = 0;
bool g_statsReportedToday = false;
bool g_firstHeartbeatSuccess = false;  // 記錄是否已經打印過第一次心跳成功
datetime g_lastReportPoll = 0;         // 上次輪詢時間
bool g_reportRequested = false;        // 是否收到上報請求

//B
// ========== 新增：WebMonitor 函式 ==========

/**
 * 發送 HTTP 請求（帶重試機制）
 * @param url 完整 URL
 * @param jsonBody JSON 字串
 * @param maxRetries 最大重試次數
 * @return 成功返回 true
 */
bool SendHttpRequest(string url, string jsonBody, int maxRetries = 3) {
    for(int attempt = 1; attempt <= maxRetries; attempt++) {
        char data[];
        char result[];
        string headers = "Content-Type: application/json\r\nAuthorization: Bearer " + API_KEY + "\r\n";
        
        ArrayResize(data, StringToCharArray(jsonBody, data, 0, WHOLE_ARRAY, CP_UTF8) - 1);
        
        ResetLastError();
        int res = WebRequest("POST", url, headers, 5000, data, result, headers);
        int error = GetLastError();
        
        if(res == 200 || res == 201) {
            if(EnableDebugLog) {
                Print("✓ HTTP 請求成功: ", url);
            }
            return true;
        } else {
            Print("✗ HTTP 請求失敗 (嘗試 ", attempt, "/", maxRetries, ")");
            Print("  HTTP Code: ", res);
            Print("  Error Code: ", error);
            Print("  URL: ", url);
            
            if(error == 4060) {
                Print("  ⚠ WebRequest 未授權！請在 MT4 設定中添加 URL 到白名單：");
                Print("  工具 → 選項 → 專家顧問 → 允許 WebRequest");
                Print("  添加: ", API_BASE_URL);
                return false; // WebRequest 未授權，不重試
            }
            
            if(attempt < maxRetries) {
                int waitMs = attempt * 1000; // 指數退避
                Sleep(waitMs);
            }
        }
    }
    
    Print("✗ HTTP 請求失敗，已達最大重試次數");
    return false;
}
