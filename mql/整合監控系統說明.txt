================================================================================
如何將網頁監控整合到 A 計算盈虧 EA
================================================================================

【方法一：使用 include 模組（推薦）】

步驟 1：在 EA 最開頭添加 include
-----------------------------------
在您的 EA 檔案開頭（在所有 include 之後）添加：

#include "WebMonitor.mqh"


步驟 2：添加監控參數
-----------------------------------
在 input 參數區塊添加：

input string   __________監控系統__________ = "=====監控系統參數=====";
input string   Monitor_API_URL = "http://192.168.31.206:8080/api";
input string   Monitor_API_KEY = "secret_key_2025_9093942525abcdxyz_";
input string   Monitor_NodeID = "A1_VPS0";
input int      Monitor_HeartbeatMinutes = 15;
input bool     Monitor_AutoSend = true;


步驟 3：添加全域變數
-----------------------------------
在全域變數區塊添加：

datetime g_lastMonitorHeartbeat = 0;
bool g_dataSentToday = false;


步驟 4：在 OnInit() 中添加
-----------------------------------
在 OnInit() 函數的 return(INIT_SUCCEEDED); 之前添加：

   // 發送初始心跳到監控系統
   SendMonitorHeartbeat(Monitor_API_URL, Monitor_API_KEY, Monitor_NodeID, 
                        檔案頭ID, g_lastMonitorHeartbeat);
   Print("監控系統已啟用 - NodeID:", Monitor_NodeID);
   Print("重要：請將此網址加入 WebRequest 白名單");
   Print("網址：", Monitor_API_URL);


步驟 5：在 OnTick() 開頭添加心跳檢查
-----------------------------------
在 OnTick() 函數最開頭添加：

   // === 監控系統心跳檢查 ===
   CheckAndSendHeartbeat(Monitor_API_URL, Monitor_API_KEY, Monitor_NodeID,
                         檔案頭ID, Monitor_HeartbeatMinutes, g_lastMonitorHeartbeat);
   
   // 新的一天重置發送標記
   if(Kbar數2 != iBars(Symbol(), PERIOD_D1))
   {
      g_dataSentToday = false;
   }


步驟 6：在計算完成後發送數據
-----------------------------------
找到這段代碼（在第 i == 每日最大統計次數_要x2 的區塊內）：

          已發出TG通知1 = 1;
          Step4時間已進入4 = 1;
          Print("step4時間進入4");

在這三行之前添加：

          // === 發送到網頁監控系統 ===
          if(Monitor_AutoSend && 開始 == 0 && !g_dataSentToday)
          {
             SendMonitorABStats(
                Monitor_API_URL,
                Monitor_API_KEY,
                Monitor_NodeID,
                A手數總數,
                B手數總數,
                A盈利總數,
                B盈利總數,
                A總息,
                匯率變數
             );
             g_dataSentToday = true;
          }


================================================================================
【完整的插入位置參考】
================================================================================

在 OnTick() 中的位置：

void OnTick()
{
    // === 1. 在最開頭添加心跳 ===
    CheckAndSendHeartbeat(Monitor_API_URL, Monitor_API_KEY, Monitor_NodeID,
                          檔案頭ID, Monitor_HeartbeatMinutes, g_lastMonitorHeartbeat);
    
    if(Kbar數2 != iBars(Symbol(), PERIOD_D1))
    {
       g_dataSentToday = false;
    }

    // ... 您原有的代碼 ...
    
    for (int i = 1; i <= 每日最大統計次數_要x2; i=i+1) {
        // ... 計算 A/B 數據的代碼 ...
        
        if (i == 每日最大統計次數_要x2) {
          // ... 設定 label 的代碼 ...
          
          // === 2. 在這裡添加發送 ===
          if(Monitor_AutoSend && 開始 == 0 && !g_dataSentToday)
          {
             SendMonitorABStats(
                Monitor_API_URL, Monitor_API_KEY, Monitor_NodeID,
                A手數總數, B手數總數, A盈利總數, B盈利總數,
                A總息, 匯率變數
             );
             g_dataSentToday = true;
          }
          
          // 這三行保持原位
          已發出TG通知1 = 1;
          Step4時間已進入4 = 1;
          Print("step4時間進入4");
        }
    }
    
    // ... 其餘代碼 ...
}


================================================================================
【設定 MT5】
================================================================================

1. 工具 -> 選項 -> EA交易
2. 勾選「允許 WebRequest 使用列出的 URL」
3. 添加：http://192.168.31.206:8080
4. 點擊確定


================================================================================
【EA 參數設定】
================================================================================

Monitor_API_URL        = http://192.168.31.206:8080/api
Monitor_API_KEY        = secret_key_2025_9093942525abcdxyz_
Monitor_NodeID         = A1_VPS0  (每個 EA 要不同)
Monitor_HeartbeatMinutes = 15
Monitor_AutoSend       = true


================================================================================
【測試步驟】
================================================================================

1. 重新編譯 EA (F7)
2. 掛載到圖表
3. 查看日誌，應該看到：
   - "監控系統已啟用 - NodeID: A1_VPS0"
   - "✓ 監控心跳發送成功"

4. 按「開始」按鈕計算數據
5. 查看日誌，應該看到：
   - "✓ A/B統計發送成功到網頁"
   - 顯示 9 項數據

6. 開啟網頁：http://192.168.31.206
   應該看到節點和數據


================================================================================
【常見問題】
================================================================================

Q: 出現錯誤 4014
A: 網址未加入白名單，按上述步驟設定 MT5

Q: 出現 HTTP 401
A: API_KEY 不正確，檢查是否與伺服器 .env 檔案一致

Q: 數據沒有發送
A: 檢查 Monitor_AutoSend 是否為 true
   檢查是否按了「開始」按鈕計算數據

Q: 心跳沒有發送
A: 檢查 OnTick() 開頭是否有添加心跳檢查代碼


================================================================================
【日誌輸出範例】
================================================================================

正常運行時的日誌：

2025.11.17 19:00:00  監控系統已啟用 - NodeID: A1_VPS0
2025.11.17 19:00:00  ✓ 監控心跳發送成功
2025.11.17 19:15:00  ✓ 監控心跳發送成功
2025.11.17 23:33:00  ✓ A/B統計發送成功到網頁
2025.11.17 23:33:00    2. A手數: 10.50
2025.11.17 23:33:00    3. B手數: 8.30
2025.11.17 23:33:00    4. 手數差: 2.20
2025.11.17 23:33:00    5. A盈利: 1250.50
2025.11.17 23:33:00    6. B盈利: -320.80
2025.11.17 23:33:00    7. AB總盈利: 929.70
2025.11.17 23:33:00    8. A總息: -45.20
2025.11.17 23:33:00    9. 每手成本: 88.54


================================================================================
