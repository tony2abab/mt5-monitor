================================================================================
                MetaEditor æœå°‹æ›¿æ›æ³• - åªéœ€ 3 åˆ†é˜
================================================================================

ç”¨ MT5 MetaEditor çš„æœå°‹æ›¿æ›åŠŸèƒ½ï¼Œå¿«é€Ÿå®Œæˆæ•´åˆï¼

ã€æº–å‚™ã€‘
1. ç”¨ MT5 MetaEditor æ‰“é–‹æ‚¨çš„åŸå§‹ EA
2. å¦å­˜æ–°æª”ç‚ºï¼šAè¨ˆç®—ç›ˆè™§_r9a_ç›£æ§ç‰ˆ.mq5
3. æº–å‚™å¥½é€™å€‹æ–‡ä»¶åœ¨æ—é‚Š


================================================================================
ã€æ›¿æ› 1ã€‘æ·»åŠ ç›£æ§åƒæ•¸
================================================================================

æŒ‰ Ctrl+Hï¼ˆæœå°‹èˆ‡æ›¿æ›ï¼‰

æœå°‹ï¼š
input  double  æ¯æ‰‹æˆæœ¬è¶…éå¤šå°‘é€šçŸ¥ = -20;

æ›¿æ›ç‚ºï¼š
input  double  æ¯æ‰‹æˆæœ¬è¶…éå¤šå°‘é€šçŸ¥ = -20;

// ==================== ç¶²é ç›£æ§åƒæ•¸ ====================
input  string  __________ç¶²é ç›£æ§ç³»çµ±__________ = "=====ç¶²é ç›£æ§åƒæ•¸=====";
input  string  Monitor_API_URL = "http://192.168.31.206:8080/api";
input  string  Monitor_API_KEY = "secret_key_2025_9093942525abcdxyz_";
input  string  Monitor_NodeID = "A1_VPS0";
input  int  Monitor_HeartbeatMinutes = 15;
input  bool  Monitor_AutoSend = true;

é»æ“Šã€Œå…¨éƒ¨æ›¿æ›ã€


================================================================================
ã€æ›¿æ› 2ã€‘æ·»åŠ ç›£æ§å…¨åŸŸè®Šæ•¸
================================================================================

æŒ‰ Ctrl+H

æœå°‹ï¼š
  double  Aç¸½æ¯ = 0;

æ›¿æ›ç‚ºï¼š
  double  Aç¸½æ¯ = 0;

datetime g_lastMonitorHeartbeat = 0;
bool g_dataSentToday = false;

é»æ“Šã€Œå…¨éƒ¨æ›¿æ›ã€


================================================================================
ã€æ›¿æ› 3ã€‘æ·»åŠ ç›£æ§å‡½æ•¸ï¼ˆé€™å€‹æ¯”è¼ƒé•·ï¼‰
================================================================================

æŒ‰ Ctrl+H

æœå°‹ï¼š
     return;
}
  int  æª”æ¡ˆä»£ç¢¼ = 0;

æ›¿æ›ç‚ºï¼š
     return;
}

void SendMonitorHeartbeat() {
   string url = Monitor_API_URL + "/heartbeat";
   string headers = "Content-Type: application/json\r\nAuthorization: Bearer " + Monitor_API_KEY + "\r\n";
   string broker = AccountInfoString(ACCOUNT_COMPANY);
   string account = IntegerToString(AccountInfoInteger(ACCOUNT_LOGIN));
   string payload = "{\"id\":\"" + Monitor_NodeID + "\",\"name\":\"" + æª”æ¡ˆé ­ID + " " + å‚™è¨»_VPSä½ç½® + "\",\"broker\":\"" + broker + "\",\"account\":\"" + account + "\"}";
   char post_data[], result[];
   string result_headers;
   StringToCharArray(payload, post_data, 0, StringLen(payload));
   ResetLastError();
   int res = WebRequest("POST", url, headers, 5000, post_data, result, result_headers);
   if(res == 200 || res == 201) {
      g_lastMonitorHeartbeat = TimeCurrent();
      Print("âœ“ ç¶²é ç›£æ§å¿ƒè·³æˆåŠŸ");
   } else {
      int error_code = GetLastError();
      Print("âœ— ç›£æ§å¿ƒè·³å¤±æ•— HTTP:", res, " Error:", error_code);
      if(error_code == 4014) Print("  è«‹å°‡ç¶²å€åŠ å…¥ç™½åå–®: ", Monitor_API_URL);
   }
}

void SendMonitorABStats() {
   if(!Monitor_AutoSend) return;
   string url = Monitor_API_URL + "/ab-stats";
   string headers = "Content-Type: application/json\r\nAuthorization: Bearer " + Monitor_API_KEY + "\r\n";
   double lots_diff = Aæ‰‹æ•¸ç¸½æ•¸ - Bæ‰‹æ•¸ç¸½æ•¸;
   double a_profit_usd = Aç›ˆåˆ©ç¸½æ•¸ / åŒ¯ç‡è®Šæ•¸;
   double ab_total = a_profit_usd + Bç›ˆåˆ©ç¸½æ•¸;
   double cost_per_lot = (Aæ‰‹æ•¸ç¸½æ•¸ > 0) ? (ab_total / Aæ‰‹æ•¸ç¸½æ•¸) : 0;
   MqlDateTime tm;
   TimeToStruct(TimeCurrent(), tm);
   string today_date = StringFormat("%04d-%02d-%02d", tm.year, tm.mon, tm.day);
   string payload = "{\"id\":\"" + Monitor_NodeID + "\",\"date\":\"" + today_date + "\",";
   payload += "\"a_lots_total\":" + DoubleToString(Aæ‰‹æ•¸ç¸½æ•¸, 2) + ",";
   payload += "\"b_lots_total\":" + DoubleToString(Bæ‰‹æ•¸ç¸½æ•¸, 2) + ",";
   payload += "\"lots_diff\":" + DoubleToString(lots_diff, 2) + ",";
   payload += "\"a_profit_total\":" + DoubleToString(a_profit_usd, 2) + ",";
   payload += "\"b_profit_total\":" + DoubleToString(Bç›ˆåˆ©ç¸½æ•¸, 2) + ",";
   payload += "\"ab_profit_total\":" + DoubleToString(ab_total, 2) + ",";
   payload += "\"a_interest_total\":" + DoubleToString(Aç¸½æ¯, 2) + ",";
   payload += "\"cost_per_lot\":" + DoubleToString(cost_per_lot, 2) + "}";
   char post_data[], result[];
   string result_headers;
   StringToCharArray(payload, post_data, 0, StringLen(payload));
   ResetLastError();
   int res = WebRequest("POST", url, headers, 5000, post_data, result, result_headers);
   if(res == 200 || res == 201) {
      g_dataSentToday = true;
      Print("âœ“ A/Bçµ±è¨ˆç™¼é€æˆåŠŸ");
      Print("  Aæ‰‹æ•¸:", Aæ‰‹æ•¸ç¸½æ•¸, " Bæ‰‹æ•¸:", Bæ‰‹æ•¸ç¸½æ•¸);
      Print("  ABç¸½ç›ˆåˆ©:", ab_total, " æ¯æ‰‹æˆæœ¬:", cost_per_lot);
   } else {
      Print("âœ— çµ±è¨ˆç™¼é€å¤±æ•— HTTP:", res, " Error:", GetLastError());
   }
}

  int  æª”æ¡ˆä»£ç¢¼ = 0;

é»æ“Šã€Œå…¨éƒ¨æ›¿æ›ã€


================================================================================
ã€æ›¿æ› 4ã€‘OnInit åˆå§‹åŒ–
================================================================================

æŒ‰ Ctrl+H

æœå°‹ï¼š
  S4_åˆ†åŠ ä¸€ = Step4_ICåˆ†_0to58 + 1;

 return(INIT_SUCCEEDED);

æ›¿æ›ç‚ºï¼š
  S4_åˆ†åŠ ä¸€ = Step4_ICåˆ†_0to58 + 1;

  SendMonitorHeartbeat();
  Print("========================================== ç¶²é ç›£æ§å·²å•Ÿç”¨ NodeID: ", Monitor_NodeID, " ==========================================");

 return(INIT_SUCCEEDED);

é»æ“Šã€Œå…¨éƒ¨æ›¿æ›ã€


================================================================================
ã€æ›¿æ› 5ã€‘OnTick å¿ƒè·³æª¢æŸ¥
================================================================================

æŒ‰ Ctrl+H

æœå°‹ï¼š
void OnTick()
{
    if (get_time_info_hour((TimeLocal() - TimeGMT())) == 8) {

æ›¿æ›ç‚ºï¼š
void OnTick()
{
    if(TimeCurrent() - g_lastMonitorHeartbeat >= Monitor_HeartbeatMinutes * 60) SendMonitorHeartbeat();
    static int last_day = 0;
    int current_day = get_time_info_day(TimeCurrent());
    if(current_day != last_day) { g_dataSentToday = false; last_day = current_day; }
    
    if (get_time_info_hour((TimeLocal() - TimeGMT())) == 8) {

é»æ“Šã€Œå…¨éƒ¨æ›¿æ›ã€


================================================================================
ã€æ›¿æ› 6ã€‘ç™¼é€çµ±è¨ˆæ•¸æ“š
================================================================================

æŒ‰ Ctrl+H

æœå°‹ï¼š
        }
      }
      if (é–‹å§‹ == 0) {
        æ¸¬è©¦TGé€šçŸ¥ = 0;

æ›¿æ›ç‚ºï¼š
        }
      }
      if(Monitor_AutoSend && é–‹å§‹ == 0 && !g_dataSentToday) {
         Print("=== æº–å‚™ç™¼é€ A/B çµ±è¨ˆ ===");
         SendMonitorABStats();
      }
      if (é–‹å§‹ == 0) {
        æ¸¬è©¦TGé€šçŸ¥ = 0;

é»æ“Šã€Œå…¨éƒ¨æ›¿æ›ã€


================================================================================
ã€å®Œæˆã€‘å„²å­˜ä¸¦ç·¨è­¯
================================================================================

1. Ctrl+S å„²å­˜
2. F7 ç·¨è­¯
3. æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤ï¼ˆæ‡‰è©²æ²’æœ‰ï¼‰
4. è¨­å®š WebRequest ç™½åå–®ï¼šhttp://192.168.31.206:8080
5. æ›è¼‰ EA æ¸¬è©¦


================================================================================
ã€æç¤ºã€‘
================================================================================

- å¦‚æœæ‰¾ä¸åˆ°æŸå€‹æœå°‹å…§å®¹ï¼Œå¯èƒ½æ˜¯ç©ºæ ¼æˆ–æ›è¡Œä¸åŒ
- å¯ä»¥æ‰‹å‹•æœå°‹é—œéµå­—ï¼Œç„¶å¾Œæ‰‹å‹•æ·»åŠ 
- æœ€é—œéµçš„æ˜¯æ›¿æ› 6ï¼ˆç™¼é€çµ±è¨ˆæ•¸æ“šï¼‰ï¼Œå¦‚æœå…¶ä»–éƒ½æˆåŠŸä½†é€™å€‹å¤±æ•—ï¼Œ
  å°±æ‰‹å‹•æœå°‹ã€Œæ¸¬è©¦TGé€šçŸ¥ = 0;ã€ç„¶å¾Œåœ¨å‰é¢æ‰‹å‹•åŠ å…¥ç™¼é€ä»£ç¢¼


================================================================================
ã€æ¸¬è©¦æˆåŠŸçš„æ¨™èªŒã€‘
================================================================================

æ—¥èªŒæ‡‰è©²çœ‹åˆ°ï¼š
========================================== ç¶²é ç›£æ§å·²å•Ÿç”¨ NodeID: A1_VPS0 ==========================================
âœ“ ç¶²é ç›£æ§å¿ƒè·³æˆåŠŸ
=== æº–å‚™ç™¼é€ A/B çµ±è¨ˆ ===
âœ“ A/Bçµ±è¨ˆç™¼é€æˆåŠŸ


å®Œæˆï¼ğŸ‰
================================================================================
