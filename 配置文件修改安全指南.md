# 配置文件修改安全指南

## 🚨 為什麼需要這個指南

**問題：** 在修改配置文件時，如果使用舊版本覆蓋，會導致之前添加的功能配置丟失。

**後果：**
- 功能失效（如交易時段限制失效）
- 需要重新添加配置
- 浪費時間排查問題

---

## ✅ 安全修改流程

### 步驟 1：備份當前配置

**每次修改前先備份：**

```powershell
# 運行備份腳本
.\backup-config.ps1
```

這會在 `config_backups` 目錄創建帶時間戳的備份。

### 步驟 2：驗證當前配置

**確認所有配置都存在：**

```bash
# 運行驗證腳本
node verify-config.js
```

應該看到所有配置項都有 ✓ 標記。

### 步驟 3：使用 Git 查看歷史

**查看文件修改歷史：**

```bash
# 查看最近的修改
git log --oneline backend/ecosystem.config.js

# 查看具體修改內容
git show HEAD:backend/ecosystem.config.js
```

### 步驟 4：只修改需要改的部分

**❌ 錯誤做法：**
```javascript
// 直接覆蓋整個文件
module.exports = {
  apps: [{
    env: {
      PORT: 8080,
      // 只有新配置，舊配置丟失了！
    }
  }]
};
```

**✅ 正確做法：**
```javascript
// 只添加或修改特定配置項
env: {
  // ... 保留所有現有配置 ...
  PORT: 8080,
  API_KEY: 'xxx',
  TRADING_HOURS_ENABLED: 'true',  // 新增
  // ... 其他配置 ...
}
```

### 步驟 5：修改後驗證

**再次運行驗證腳本：**

```bash
node verify-config.js
```

確認所有配置項仍然存在。

### 步驟 6：提交到 Git

**保存修改歷史：**

```bash
git add backend/ecosystem.config.js
git commit -m "Add XXX configuration"
```

---

## 🛠️ 工具使用

### 1. 備份腳本（backup-config.ps1）

**功能：**
- 自動備份所有重要配置文件
- 創建帶時間戳的備份目錄
- 保留修改歷史

**使用：**
```powershell
.\backup-config.ps1
```

**恢復備份：**
```powershell
# 查看備份
ls .\config_backups\

# 恢復特定備份
Copy-Item .\config_backups\20251127_095500\ecosystem.config.js .\backend\ecosystem.config.js
```

### 2. 驗證腳本（verify-config.js）

**功能：**
- 檢查所有必要配置項是否存在
- 防止配置丟失
- 修改前後都應運行

**使用：**
```bash
node verify-config.js
```

**輸出示例：**
```
✓ PORT                           - 服務端口
✓ TRADING_HOURS_ENABLED          - 交易時段啟用
✗ SOME_CONFIG                    - 某配置 (缺失)
```

---

## 📋 必須包含的配置項清單

### ecosystem.config.js

```javascript
env: {
  // 基本配置
  NODE_ENV: 'production',
  PORT: 8080,
  DB_PATH: 'C:/MT5_Monitor/data/monitor.db',
  ENABLE_AUTH: 'true',
  API_KEY: 'your-secret-api-key-here',
  
  // 心跳配置
  HEARTBEAT_TIMEOUT_SECONDS: 300,
  
  // 交易時段配置（重要！）
  TRADING_HOURS_ENABLED: 'true',
  TRADING_TIMEZONE: 'Europe/London',
  TRADING_DAYS_START: '1',
  TRADING_DAYS_END: '5',
  TRADING_HOURS_START: '01:30',
  TRADING_HOURS_END: '23:30',
  
  // 網絡配置
  CORS_ORIGIN: '*',
  RATE_LIMIT_PER_MIN: 60,
  
  // 定時上報
  REPORT_TIME_1: '45 23 * * *',
  REPORT_TIME_2: '0 10 * * *',
  
  // Telegram 通知
  TELEGRAM_BOT_TOKEN: '',
  TELEGRAM_CHAT_ID: ''
}
```

---

## 🔍 常見錯誤和解決方法

### 錯誤 1：使用舊模板覆蓋

**症狀：**
- 之前添加的配置消失
- 功能突然失效

**原因：**
- 使用了舊版本的配置文件
- 沒有先讀取當前版本

**解決：**
1. 從 Git 歷史恢復：
   ```bash
   git checkout HEAD -- backend/ecosystem.config.js
   ```
2. 或從備份恢復：
   ```bash
   Copy-Item .\config_backups\最新備份\ecosystem.config.js .\backend\
   ```

### 錯誤 2：忘記某些配置

**症狀：**
- 驗證腳本報錯
- 某些功能不工作

**解決：**
1. 運行驗證腳本查看缺失項
2. 參考上面的清單添加缺失配置
3. 再次驗證

### 錯誤 3：修改後沒有提交

**症狀：**
- 無法追蹤修改歷史
- 不知道何時改了什麼

**解決：**
- 養成每次修改後提交的習慣
- 使用有意義的 commit 訊息

---

## 📝 修改檢查清單

每次修改配置文件時，請確認：

- [ ] 已運行備份腳本
- [ ] 已讀取當前文件內容
- [ ] 只修改需要改的部分
- [ ] 保留所有現有配置
- [ ] 修改後運行驗證腳本
- [ ] 所有配置項都存在
- [ ] 提交到 Git
- [ ] 在 VPS 上測試

---

## 🎯 最佳實踐

### 1. 永遠先讀取，再修改

```bash
# 先查看當前內容
cat backend/ecosystem.config.js

# 或在編輯器中打開
code backend/ecosystem.config.js
```

### 2. 使用增量修改

- 優先使用 `edit` 工具
- 避免使用 `write_to_file` 覆蓋
- 只改需要改的行

### 3. 定期備份

```bash
# 每天備份一次
.\backup-config.ps1
```

### 4. 保持 Git 歷史清晰

```bash
# 有意義的 commit 訊息
git commit -m "Add trading hours configuration for weekend filtering"

# 而不是
git commit -m "update config"
```

### 5. 文檔化配置變更

在 `CHANGES_*.md` 文件中記錄重要配置變更。

---

## 🚀 快速參考

### 修改前
```bash
.\backup-config.ps1          # 備份
node verify-config.js        # 驗證
```

### 修改後
```bash
node verify-config.js        # 再次驗證
git add backend/ecosystem.config.js
git commit -m "描述修改內容"
```

### 出問題時
```bash
git log backend/ecosystem.config.js     # 查看歷史
git show HEAD:backend/ecosystem.config.js  # 查看上一版本
git checkout HEAD -- backend/ecosystem.config.js  # 恢復
```

---

**記住：配置文件是系統的核心，修改時必須謹慎！**

**最後更新：** 2025-11-27
