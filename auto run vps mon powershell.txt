# ========== 創建 VPS 效能監測排程任務 ==========

Write-Host "`n開始創建排程任務..." -ForegroundColor Cyan

# 1. 定義執行動作（執行 PowerShell 腳本）
$action = New-ScheduledTaskAction `
    -Execute "PowerShell.exe" `
    -Argument "-NoProfile -ExecutionPolicy Bypass -File C:\VPS_Monitor\vps-monitor-agent.ps1"

Write-Host "✓ 動作已定義" -ForegroundColor Green

# 2. 定義觸發器（每 5 分鐘執行一次）
$trigger = New-ScheduledTaskTrigger `
    -Once `
    -At (Get-Date) `
    -RepetitionInterval (New-TimeSpan -Minutes 5)

Write-Host "✓ 觸發器已定義（每 5 分鐘執行）" -ForegroundColor Green

# 3. 定義執行身份（使用 SYSTEM 帳戶，最高權限）
$principal = New-ScheduledTaskPrincipal `
    -UserId "SYSTEM" `
    -LogonType ServiceAccount `
    -RunLevel Highest

Write-Host "✓ 執行身份已定義（SYSTEM 帳戶）" -ForegroundColor Green

# 4. 定義任務設定（允許在電池模式下執行，開機後自動啟動）
$settings = New-ScheduledTaskSettingsSet `
    -AllowStartIfOnBatteries `
    -DontStopIfGoingOnBatteries `
    -StartWhenAvailable `
    -ExecutionTimeLimit (New-TimeSpan -Minutes 2)

Write-Host "✓ 任務設定已定義" -ForegroundColor Green

# 5. 註冊排程任務
Register-ScheduledTask `
    -TaskName "VPS_Performance_Monitor" `
    -Action $action `
    -Trigger $trigger `
    -Principal $principal `
    -Settings $settings `
    -Description "VPS 效能監測 - 每 5 分鐘自動執行，發送數據到主控 VPS" `
    -Force

Write-Host "`n✓ 排程任務創建成功！" -ForegroundColor Green
Write-Host "  任務名稱：VPS_Performance_Monitor" -ForegroundColor Yellow
Write-Host "  執行頻率：每 5 分鐘" -ForegroundColor Yellow
Write-Host "  執行帳戶：SYSTEM" -ForegroundColor Yellow

# 6. 驗證任務
Write-Host "`n正在驗證任務..." -ForegroundColor Cyan
$task = Get-ScheduledTask -TaskName "VPS_Performance_Monitor" -ErrorAction SilentlyContinue

if ($task) {
    Write-Host "✓ 任務驗證成功！" -ForegroundColor Green
    Write-Host "  狀態：$($task.State)" -ForegroundColor Gray
    
    # 顯示下次執行時間
    $taskInfo = Get-ScheduledTaskInfo -TaskName "VPS_Performance_Monitor"
    Write-Host "  下次執行：$($taskInfo.NextRunTime)" -ForegroundColor Gray
} else {
    Write-Host "✗ 任務驗證失敗" -ForegroundColor Red
}

Write-Host "`n========== 完成 ==========" -ForegroundColor Cyan
